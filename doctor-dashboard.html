<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Doctor Dashboard â€¢ MEDUCO</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <a href="index.html" class="brand">MEDUCO</a>
        <nav class="nav" id="nav">
          <a href="patients.html">Patients</a>
          <a href="care-plans.html">Care Plans</a>
          <a href="appointments.html">Appointments</a>
          <a href="records.html">Records</a>
          <a href="doctor-messages.html">Messages</a>
          <a href="login.html">Logout</a>
        </nav>
        <button aria-label="Toggle menu" class="nav-toggle responsive-show" id="navToggle">
          <span></span><span></span><span></span>
        </button>
      </div>
    </header>

    <main>
      <section class="section">
        <div class="container">
          <h1 class="text-responsive-3xl">Welcome, <span id="doctorName">Doctor</span></h1>
          <p class="muted text-responsive-base">Today's schedule and patients requiring attention.</p>

          <!-- Practice Overview -->
          <div class="grid-4" style="margin-bottom: 24px;">
            <div class="overview-card">
              <div class="overview-icon">ðŸ‘¥</div>
              <div class="overview-content">
            <div class="overview-card">
              <div class="overview-icon">ðŸ‘¥</div>
              <div class="overview-content">
                <div class="overview-value text-responsive-2xl"></div>
                <div class="overview-label text-responsive-base">Total Patients</div>
              </div>
            </div>
            <div class="overview-card">
              <div class="overview-icon">ðŸ“…</div>
              <div class="overview-content">
                <div class="overview-value text-responsive-2xl"></div>
                <div class="overview-label text-responsive-base">Today's Appointments</div>
              </div>
            </div>
            <div class="overview-card">
              <div class="overview-icon">ðŸ”´</div>
              <div class="overview-content">
                <div class="overview-value text-responsive-2xl"></div>
                <div class="overview-label text-responsive-base">Urgent Alerts</div>
              </div>
            </div>
            <div class="overview-card">
              <div class="overview-icon">ðŸ“Š</div>
              <div class="overview-content">
                <div class="overview-value text-responsive-2xl"></div>
                <div class="overview-label text-responsive-base">Patient Satisfaction</div>
              </div>
            </div>
          </div>

          <!-- Charts Section -->
          <div class="grid-2" style="margin-bottom: 24px;">
            <div class="card">
              <h3 style="margin-top: 0;" class="text-responsive-xl">Weekly Appointment Trends</h3>
              <div class="chart-container">
                <canvas id="appointmentChart" width="400" height="200"></canvas>
              </div>
            </div>
            <div class="card">
              <h3 style="margin-top: 0;" class="text-responsive-xl">Patient Age Distribution</h3>
              <div class="chart-container">
                <canvas id="ageChart" width="400" height="200"></canvas>
              </div>
            </div>
          </div>

          <!-- Patient Statistics -->
          <div class="grid-3" style="margin-bottom: 24px;">
            <div class="card">
              <h3 style="margin-top: 0;" class="text-responsive-xl">Top Conditions</h3>
              <!-- Removed hardcoded sample data - will be populated from backend -->
            </div>
            <div class="card">
              <h3 style="margin-top: 0;" class="text-responsive-xl">Recent Lab Results</h3>
              <!-- Removed hardcoded sample data - will be populated from backend -->
            </div>
            <div class="card">
              <h3 style="margin-top: 0;" class="text-responsive-xl">Care Plan Status</h3>
              <!-- Removed hardcoded sample data - will be populated from backend -->
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <h3 style="margin-top:0">Today's Appointments</h3>
              <button class="btn btn-primary" id="btnNewAppointment" style="margin-bottom: 12px;">New Appointment</button>
              <div id="newAppointmentModalContainer"></div>
              <div id="exportAppointmentModalContainer"></div>
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>Time</th>
                      <th>Patient</th>
                      <th>Reason</th>
                    </tr>
                  </thead>
                  <tbody>
                  <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                  </tr>
                  <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="card">
              <h3 style="margin-top:0">AI Insights</h3>
              <ul>
                <li>3 patients have overdue labs</li>
                <li>1 high-risk alert for medication adherence</li>
              </ul>
            </div>
          </div>

          <!-- New Appointment Modal -->
          <div id="newAppointmentModalContainer"></div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container">
        Â© <span id="year"></span> MEDUCO
      </div>
    </footer>

    <script src="api.js"></script>
    <script src="script.js"></script>
    <script src="enhanced-appointments-script.js"></script>
    <script>
      // Load doctor dashboard data from API
      window.addEventListener('DOMContentLoaded', async function() {
        try {
          // Check if user is authenticated
          if (!window.meducoAPI.isAuthenticated()) {
            window.location.href = 'login.html'
            return
          }

          // Get user data
          const userData = window.meducoAPI.getUserData()
          if (userData && userData.role !== 'doctor') {
            window.location.href = 'login.html'
            return
          }

          // Load dashboard data from API
          const dashboardData = await window.meducoAPI.getDoctorDashboard()
          
          if (dashboardData.success) {
            const data = dashboardData.data
            
            // Update doctor name
            if (data.doctor) {
              document.getElementById('doctorName').textContent = `Dr. ${data.doctor.first_name} ${data.doctor.last_name}`
            }

            // Update overview cards
            if (data.totalPatients !== undefined) {
              const totalPatientsCard = document.querySelector('.overview-card:nth-child(1) .overview-value')
              if (totalPatientsCard) {
                totalPatientsCard.textContent = data.totalPatients
              }
            }

            if (data.todayAppointments && data.todayAppointments.length !== undefined) {
              const todayAppointmentsCard = document.querySelector('.overview-card:nth-child(2) .overview-value')
              if (todayAppointmentsCard) {
                todayAppointmentsCard.textContent = data.todayAppointments.length
              }
            }

            if (data.pendingAppointments !== undefined) {
              const urgentAlertsCard = document.querySelector('.overview-card:nth-child(3) .overview-value')
              if (urgentAlertsCard) {
                urgentAlertsCard.textContent = data.pendingAppointments
              }
            }

            // Update today's appointments table
            if (data.todayAppointments && data.todayAppointments.length > 0) {
              const appointmentsTable = document.querySelector('table tbody')
              if (appointmentsTable) {
                appointmentsTable.innerHTML = data.todayAppointments.map(appointment => `
                  <tr>
                    <td>${appointment.appointment_time}</td>
                    <td>${appointment.first_name} ${appointment.last_name}</td>
                    <td>${appointment.reason || appointment.type}</td>
                  </tr>
                `).join('')
              }
            }

            // Update AI insights
            const insightsList = document.querySelector('.card:last-child ul')
            if (insightsList && data.pendingAppointments > 0) {
              insightsList.innerHTML = `
                <li>${data.pendingAppointments} appointments pending review</li>
                <li>Recent patient activity looks normal</li>
              `
            }
          }
        } catch (error) {
          console.error('Error loading dashboard:', error)
          if (error.message.includes('Token expired') || error.message.includes('Invalid token')) {
            window.location.href = 'login.html'
          }
        }

        // Removed fallback to localStorage for doctorName to use only real-time backend data
        // const doctorName = localStorage.getItem('doctorName')
        // if (doctorName && document.getElementById('doctorName').textContent === 'Doctor') {
        //   document.getElementById('doctorName').textContent = doctorName
        // }
      })

      // Simple chart rendering using Canvas
      function drawAppointmentChart() {
        const canvas = document.getElementById('appointmentChart');
        const ctx = canvas.getContext('2d');
        
        // Chart data - removed hardcoded sample data
        const data = []; // Will be populated from backend if available
        const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        
        const width = canvas.width;
        const height = canvas.height;
        const barWidth = (width - 40) / data.length;
        const maxValue = Math.max(...data);
        
        // Clear canvas
        ctx.clearRect(0, 0, width, height);
        
        // Draw bars
        data.forEach((value, index) => {
          const barHeight = (value / maxValue) * (height - 60);
          const x = 20 + index * barWidth;
          const y = height - 40 - barHeight;
          
          // Bar
          ctx.fillStyle = '#2563eb';
          ctx.fillRect(x, y, barWidth - 4, barHeight);
          
          // Value
          ctx.fillStyle = '#374151';
          ctx.font = '12px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(value, x + barWidth/2, y - 5);
          
          // Label
          ctx.fillText(labels[index], x + barWidth/2, height - 15);
        });
      }
      
      function drawAgeChart() {
        const canvas = document.getElementById('ageChart');
        const ctx = canvas.getContext('2d');
        
        // Chart data - removed hardcoded sample data
        const data = []; // Will be populated from backend if available
        
        const width = canvas.width;
        const height = canvas.height;
        const centerX = width / 2;
        const centerY = height / 2;
        const radius = Math.min(centerX, centerY) - 30;
        
        // Clear canvas
        ctx.clearRect(0, 0, width, height);
        
        // Calculate total
        const total = data.reduce((sum, item) => sum + item.value, 0);
        
        // Draw pie chart
        let currentAngle = -Math.PI / 2;
        data.forEach(item => {
          const sliceAngle = (item.value / total) * 2 * Math.PI;
          
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
          ctx.closePath();
          ctx.fillStyle = item.color;
          ctx.fill();
          
          // Draw label
          const labelAngle = currentAngle + sliceAngle / 2;
          const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
          const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
          
          ctx.fillStyle = '#374151';
          ctx.font = '10px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(item.label, labelX, labelY);
          
          currentAngle += sliceAngle;
        });
      }
      
      // Initialize charts when page loads
      document.addEventListener('DOMContentLoaded', function() {
        drawAppointmentChart();
        drawAgeChart();

        // Removed fallback to localStorage for doctorName to use only real-time backend data
        // const doctorName = localStorage.getItem('doctorName');
        // if (doctorName) {
        //   document.getElementById('doctorName').textContent = doctorName;
        // }

        // Load new appointment modal
        loadNewAppointmentModal();
      });

      async function loadNewAppointmentModal() {
        try {
          // Instead of fetch, directly insert modal HTML content here to avoid CORS issues
          const modalHtml = `
            <div id="newAppointmentModal" class="modal" style="display:none;">
              <div class="modal-content">
                <span class="close" id="closeNewAppointmentModal">&times;</span>
                <h2>New Appointment</h2>
                <div id="patientLookupStep">
                  <label for="patientLookup">Enter Patient Name or ID:</label>
                  <input type="text" id="patientLookup" name="patientLookup" placeholder="Patient name or ID" required>
                  <button type="button" class="btn btn-primary" id="btnLookupPatient">Lookup Patient</button>
                  <div id="patientLookupResult" style="margin-top: 16px;"></div>
                </div>
                <div id="appointmentDetailsStep" style="display: none;">
                  <h3 id="appointmentStepTitle">Schedule Appointment</h3>
                  <form id="newAppointmentForm">
                    <input type="hidden" id="selectedPatientId" name="patientId">
                    
                    <label for="appointmentDate">Date:</label>
                    <input type="date" id="appointmentDate" name="appointmentDate" required>

                    <label for="appointmentTime">Time:</label>
                    <input type="time" id="appointmentTime" name="appointmentTime" required>

                    <label for="appointmentType">Type:</label>
                    <select id="appointmentType" name="appointmentType" required>
                      <option value="">Select type</option>
                      <option value="normal">Normal</option>
                      <option value="emergency">Emergency</option>
                      <option value="follow-up">Follow-up</option>
                      <option value="consultation">Consultation</option>
                    </select>

                    <label for="reason">Reason:</label>
                    <textarea id="reason" name="reason" rows="3" required></textarea>

                    <button type="submit" class="btn btn-primary">Create Appointment</button>
                    <button type="button" class="btn btn-outline" id="btnBackToLookup">Back</button>
                  </form>
                </div>
              </div>
            </div>
          `;
          document.getElementById('newAppointmentModalContainer').innerHTML = modalHtml;

          // Bind modal events
          const btnNewAppointment = document.getElementById('btnNewAppointment');
          const newAppointmentModal = document.getElementById('newAppointmentModal');
          const closeNewAppointmentModal = document.getElementById('closeNewAppointmentModal');

          if (btnNewAppointment && newAppointmentModal) {
            btnNewAppointment.addEventListener('click', () => {
              newAppointmentModal.style.display = 'block';
              newAppointmentModal.classList.add('show');
            });
          }

          if (closeNewAppointmentModal) {
            closeNewAppointmentModal.addEventListener('click', () => {
              newAppointmentModal.style.display = 'none';
              newAppointmentModal.classList.remove('show');
            });
          }

          // Close modal when clicking outside
          window.addEventListener('click', (event) => {
            if (event.target === newAppointmentModal) {
              newAppointmentModal.style.display = 'none';
            }
          });

        } catch (error) {
          console.error('Error loading new appointment modal:', error);
        }
      }
    </script>
  </body>
</html> 