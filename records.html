<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Medical Records • MEDUCO</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <a href="index.html" class="brand">MEDUCO</a>
        <nav class="nav" id="nav">

          <a href="patients.html">Patients</a>
          <a href="care-plans.html">Care Plans</a>
          <a href="appointments.html">Appointments</a>
          <a href="records.html" aria-current="page">Records</a>

        </nav>
        <button aria-label="Toggle menu" class="nav-toggle" id="navToggle">
          <span></span><span></span><span></span>
        </button>
      </div>
    </header>

    <main>
      <section class="section">
        <div class="container">
          <div style="margin-bottom: 16px;">
            <a href="doctor-dashboard.html" style="color: var(--brand); text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
              ← Back to Dashboard
            </a>
          </div>
          <h1>Medical Records</h1>
          <p class="muted">Securely view lab results, medications, and notes. <span class="badge">FHIR-ready</span></p>
          <div class="card">
            <h3 style="margin-top: 0;">Search Patient Records</h3>
            <div class="row">
              <input class="input" id="patientIDInput" placeholder="Enter Patient ID (e.g., PAT123456)" />
              <button class="btn btn-primary" onclick="searchPatientRecords()">Search Records</button>
            </div>
          </div>

          <div class="card">
            <h3 style="margin-top: 0;">Upload Patient Records</h3>
            <form id="uploadForm" enctype="multipart/form-data">
              <div class="row">
                <input class="input" id="uploadPatientID" placeholder="Patient ID for upload" required />
                <input type="file" id="recordFile" accept=".pdf" required style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
                <button type="submit" class="btn btn-primary">Upload Record</button>
              </div>
              <div class="form-note" id="uploadNote" role="status" aria-live="polite" style="margin-top: 8px;"></div>
            </form>
          </div>

          <div class="card" id="patientRecords" style="margin-top: 24px; display: none;">
            <h3 style="margin-top: 0;">Patient Records - <span id="patientName"></span></h3>
            <p class="muted">Patient ID: <strong id="displayPatientID"></strong></p>
            
            <div class="grid-2" style="margin-top: 16px;">
              <div class="mini-card">
                <div class="mini-label">Age</div>
                <div class="mini-value" id="patientAge">-</div>
              </div>
              <div class="mini-card">
                <div class="mini-label">Blood Type</div>
                <div class="mini-value" id="patientBloodType">-</div>
              </div>
            </div>

            <h4 style="margin: 24px 0 16px;">Recent Lab Results</h4>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Test</th>
                    <th>Result</th>
                    <th>Reference Range</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="labResultsTable">
                  <!-- Lab results will be populated here -->
                </tbody>
              </table>
            </div>

            <h4 style="margin: 24px 0 16px;">Current Medications</h4>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Medication</th>
                    <th>Dosage</th>
                    <th>Frequency</th>
                    <th>Start Date</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="medicationsTable">
                  <!-- Medications will be populated here -->
                </tbody>
              </table>
            </div>

            <h4 style="margin: 24px 0 16px;">Medical History</h4>
            <div class="card" style="background: #f8fafc; border: 1px solid #e2e8f0;">
              <div id="medicalHistory">
                <!-- Medical history will be populated here -->
              </div>
            </div>
          </div>

          <div class="card" id="noRecordsFound" style="margin-top: 24px; display: none; text-align: center; padding: 32px;">
            <h3 style="margin: 0 0 16px; color: var(--text-secondary);">No Records Found</h3>
            <p class="muted">No medical records found for the provided Patient ID. Please verify the ID and try again.</p>
          </div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container">
        © <span id="year"></span> MEDUCO
      </div>
    </footer>

    <script src="script.js"></script>
    <script>
      // Remove local patientRecords object and update searchPatientRecords to call backend API
      async function searchPatientRecords() {
        const patientID = document.getElementById('patientIDInput').value.trim().toUpperCase();
        const patientRecordsDiv = document.getElementById('patientRecords');
        const noRecordsFoundDiv = document.getElementById('noRecordsFound');

        if (!patientID) {
          alert('Please enter a Patient ID');
          return;
        }

        try {
          const response = await fetch(`/patients/search?patientId=${encodeURIComponent(patientID)}`, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
            }
          });

          if (!response.ok) {
            throw new Error('Patient not found');
          }

          const result = await response.json();

          if (result.success && result.data) {
            noRecordsFoundDiv.style.display = 'none';
            patientRecordsDiv.style.display = 'block';

            const patient = result.data;
            document.getElementById('patientName').textContent = patient.name;
            document.getElementById('displayPatientID').textContent = patient.patientId;
            document.getElementById('patientAge').textContent = patient.age;
            document.getElementById('patientBloodType').textContent = patient.bloodType;

            // Populate lab results
            const labResultsTable = document.getElementById('labResultsTable');
            labResultsTable.innerHTML = patient.labResults.map(result => `
              <tr>
                <td>${result.date}</td>
                <td>${result.test}</td>
                <td>${result.result}</td>
                <td>${result.reference}</td>
                <td><span class="badge" style="background: ${result.status === 'Normal' ? '#dcfce7' : '#fef3c7'}; color: ${result.status === 'Normal' ? '#166534' : '#92400e'};">
                  ${result.status}
                </span></td>
              </tr>
            `).join('');

            // Populate medications
            const medicationsTable = document.getElementById('medicationsTable');
            medicationsTable.innerHTML = patient.medications.map(med => `
              <tr>
                <td>${med.name}</td>
                <td>${med.dosage}</td>
                <td>${med.frequency}</td>
                <td>${med.startDate}</td>
                <td><span class="badge" style="background: #dcfce7; color: #166534;">${med.status}</span></td>
              </tr>
            `).join('');

            // Populate medical history
            const medicalHistoryDiv = document.getElementById('medicalHistory');
            medicalHistoryDiv.innerHTML = patient.medicalHistory.map(history => `
              <div style="padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: var(--text-secondary);">•</span> ${history}
              </div>
            `).join('');
          } else {
            patientRecordsDiv.style.display = 'none';
            noRecordsFoundDiv.style.display = 'block';
          }
        } catch (error) {
          patientRecordsDiv.style.display = 'none';
          noRecordsFoundDiv.style.display = 'block';
          noRecordsFoundDiv.querySelector('h3').textContent = 'Patient Data Not Found';
        }
      }

      // Allow Enter key to trigger search
      document.getElementById('patientIDInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchPatientRecords();
        }
      });
    </script>
  </body>
</html> 